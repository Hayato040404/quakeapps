<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EWCアプリ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/ewc.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/ewc.png">
</head>
<body>
  <h1>地震情報通知アプリ</h1>
  <button id="subscribeButton">通知を許可</button>
  <div id="earthquakeInfo"></div>
  <div id="eewInfo"></div>
  <script>
    const publicVapidKey = 'BC1T1-o4f9vLJ11ngQXOZTdKY8xd38vUyWeWyPosJ7JDJxnCPrAGtJZE_CUW4dqdh60eEUf5G-qzWjaojsSMer0';

    // Register service worker and subscribe to push notifications
    async function subscribe() {
      if ('serviceWorker' in navigator) {
        const registration = await navigator.serviceWorker.register('/service-worker.js');
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
        });

        await fetch('/subscribe', {
          method: 'POST',
          body: JSON.stringify(subscription),
          headers: {
            'Content-Type': 'application/json'
          }
        });

        alert('通知が許可されました！');
      } else {
        alert('このブラウザはプッシュ通知をサポートしていません。');
      }
    }

    document.getElementById('subscribeButton').addEventListener('click', () => {
      subscribe().catch(err => console.error(err));
    });

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Fetch earthquake information and display it
    async function fetchEarthquakeInfo() {
      const response = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=5');
      const data = await response.json();
      displayEarthquakeInfo(data);
    }

    function displayEarthquakeInfo(earthquakes) {
      const container = document.getElementById('earthquakeInfo');
      container.innerHTML = '';
      earthquakes.forEach((earthquake, index) => {
        const time = new Date(earthquake.earthquake.time);
        const date = time.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
        const timeStr = time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        const hypocenter = earthquake.earthquake.hypocenter.name;
        const maxScale = getScaleDescription(earthquake.earthquake.maxScale);
        let magnitude = earthquake.earthquake.hypocenter.magnitude;
        let depth = earthquake.earthquake.hypocenter.depth;

        depth = depth === -1 ? '不明' : depth === 0 ? 'ごく浅い' : `約${depth}km`;
        magnitude = magnitude === -1 ? '不明' : magnitude.toFixed(1);

        const pointsByScale = groupPointsByScale(earthquake.points);
        const tsunamiInfo = getTsunamiInfo(earthquake.earthquake.domesticTsunami);
        const freeFormComment = earthquake.comments?.freeFormComment || '';

        let formattedMessage = `[地震情報]\n${date} ${timeStr}頃\n震源地：${hypocenter}\n最大震度：${maxScale}\n深さ：${depth}\n規模：M${magnitude}\n${tsunamiInfo}\n\n［各地の震度］`;

        const scaleOrder = ['7', '6強', '6弱', '5強', '5弱', '4', '3', '2', '1'];
        const sortedScales = Object.keys(pointsByScale).sort((a, b) => {
          return scaleOrder.indexOf(a) - scaleOrder.indexOf(b);
        });

        sortedScales.forEach(scale => {
          formattedMessage += `\n《震度${scale}》`;
          Object.keys(pointsByScale[scale]).forEach(pref => {
            const uniqueCities = new Set();
            pointsByScale[scale][pref].forEach(addr => {
              const cityMatch = addr.match(/([^市区町村]+[市区町村])/);
              if (cityMatch) {
                uniqueCities.add(cityMatch[1]);
              }
            });
            formattedMessage += `\n【${pref}】${Array.from(uniqueCities).join('  ')}`;
          });
        });

        if (freeFormComment) {
          formattedMessage += `\n\n【情報】\n${freeFormComment}`;
        }

        const earthquakeInfo = document.createElement('div');
        earthquakeInfo.innerHTML = `
          <p>${formattedMessage.replace(/\n/g, '<br>')}</p>
          <textarea id="comment${index}" placeholder="自作地震情報文"></textarea>
          <button onclick="shareComment(${index})">自作情報文を共有</button>
          <textarea id="editedMessage${index}" placeholder="通知メッセージを編集" style="width: 100%; height: 150px;">${formattedMessage}</textarea>
          <button onclick="shareEditedMessage(${index})">編集したメッセージを共有</button>
        `;
        container.appendChild(earthquakeInfo);
      });
    }

    // Fetch emergency earthquake warning information and display it
    async function fetchEewInfo() {
      const response = await fetch('https://api.wolfx.jp/jma_eew.json');
      const data = await response.json();
      displayEewInfo(data);
    }

    function displayEewInfo(data) {
      const container = document.getElementById('eewInfo');
      container.innerHTML = '';
      if (data.Title && data.CodeType) {
        let formattedMessage;
        if (data.isCancel) {
          formattedMessage = "先程の緊急地震速報は取り消されました。";
        } else {
          formattedMessage = formatEewMessage(data);
          if (data.isAssumption) {
            formattedMessage += "\n※この緊急地震速報は精度が低い可能性があります※";
          }
        }

        const eewInfo = document.createElement('div');
        eewInfo.innerHTML = `
          <p>${formattedMessage.replace(/\n/g, '<br>')}</p>
          <textarea id="eewComment" placeholder="自作緊急地震速報文"></textarea>
          <button onclick="shareEewComment()">自作情報文を共有</button>
          <textarea id="editedEewMessage" placeholder="通知メッセージを編集" style="width: 100%; height: 150px;">${formattedMessage}</textarea>
          <button onclick="shareEditedEewMessage()">編集したメッセージを共有</button>
        `;
        container.appendChild(eewInfo);
      }
    }

    function formatEewMessage(data) {
      return `【${data.Title} 推定最大震度${data.MaxIntensity}】\n(第${data.Serial}報)\n
${data.OriginTime.split(' ')[1]}頃、${data.Hypocenter}を震源とする地震がありました。地震の規模はM${data.Magunitude}程度、震源の深さは約${data.Depth}km、最大震度${data.MaxIntensity}程度と推定されています。`;
    }

    function shareComment(index) {
      const comment = document.getElementById(`comment${index}`).value;
      if (navigator.share) {
        navigator.share({
          title: '自作地震情報文',
          text: comment
        }).catch(console.error);
      } else {
        alert('このブラウザは共有機能をサポートしていません。');
      }
    }

    function shareEditedMessage(index) {
      const editedMessage = document.getElementById(`editedMessage${index}`).value;
      if (navigator.share) {
        navigator.share({
          title: '地震情報',
          text: editedMessage
        }).catch(console.error);
      } else {
        alert('このブラウザは共有機能をサポートしていません。');
      }
    }

    function shareEewComment() {
      const comment = document.getElementById('eewComment').value;
      if (navigator.share) {
        navigator.share({
          title: '自作緊急地震速報文',
          text: comment
        }).catch(console.error);
      } else {
        alert('このブラウザは共有機能をサポートしていません。');
      }
    }

    function shareEditedEewMessage() {
      const editedMessage = document.getElementById('editedEewMessage').value;
      if (navigator.share) {
        navigator.share({
          title: '緊急地震速報',
          text: editedMessage
        }).catch(console.error);
      } else {
        alert('このブラウザは共有機能をサポートしていません。');
      }
    }

    // Fetch earthquake info and emergency earthquake warning info on page load
    fetchEarthquakeInfo();
    fetchEewInfo();
  </script>
</body>
</html>
